<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"><title>Jakże vspaniała maszyna</title><meta name="author" content="Architektura OpenJDK dla upartych"><link rel="stylesheet" href="reveal.js/css/reset.css"><link rel="stylesheet" href="reveal.js/css/reveal.css"><link rel="stylesheet" href="reveal.js/css/theme/night.css" id="theme"><!--This CSS is generated by the Asciidoctor reveal.js converter to further integrate AsciiDoc's existing semantic with reveal.js--><style type="text/css">.reveal div.right {
  float: right
}

/* listing block */
.reveal .listingblock.stretch > .content {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre > code {
  height: 100%;
  max-height: 100%
}

/* tables */
table {
  border-collapse: collapse;
  border-spacing: 0
}

table {
  margin-bottom: 1.25em;
  border: solid 1px #dedede
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
  padding: .5em .625em .625em;
  font-size: inherit;
  text-align: left
}

table tr th, table tr td {
  padding: .5625em .625em;
  font-size: inherit
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
  display: table-cell;
  line-height: 1.6
}

td.tableblock > .content {
  margin-bottom: 1.25em
}

td.tableblock > .content > :last-child {
  margin-bottom: -1.25em
}

table.tableblock, th.tableblock, td.tableblock {
  border: 0 solid #dedede
}

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock {
  border-width: 0 1px 1px 0
}

table.grid-all > tfoot > tr > .tableblock {
  border-width: 1px 1px 0 0
}

table.grid-cols > * > tr > .tableblock {
  border-width: 0 1px 0 0
}

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock {
  border-width: 0 0 1px
}

table.grid-rows > tfoot > tr > .tableblock {
  border-width: 1px 0 0
}

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child {
  border-right-width: 0
}

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock {
  border-bottom-width: 0
}

table.frame-all {
  border-width: 1px
}

table.frame-sides {
  border-width: 0 1px
}

table.frame-topbot, table.frame-ends {
  border-width: 1px 0
}

.reveal table th.halign-left, .reveal table td.halign-left {
  text-align: left
}

.reveal table th.halign-right, .reveal table td.halign-right {
  text-align: right
}

.reveal table th.halign-center, .reveal table td.halign-center {
  text-align: center
}

.reveal table th.valign-top, .reveal table td.valign-top {
  vertical-align: top
}

.reveal table th.valign-bottom, .reveal table td.valign-bottom {
  vertical-align: bottom
}

.reveal table th.valign-middle, .reveal table td.valign-middle {
  vertical-align: middle
}

table thead th, table tfoot th {
  font-weight: bold
}

tbody tr th {
  display: table-cell;
  line-height: 1.6
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
  font-weight: bold
}

thead {
  display: table-header-group
}

.reveal table.grid-none th, .reveal table.grid-none td {
  border-bottom: 0 !important
}

/* kbd macro */
kbd {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  display: inline-block;
  color: rgba(0, 0, 0, .8);
  font-size: .65em;
  line-height: 1.45;
  background: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em #fff inset;
  margin: 0 .15em;
  padding: .2em .5em;
  vertical-align: middle;
  position: relative;
  top: -.1em;
  white-space: nowrap
}

.keyseq kbd:first-child {
  margin-left: 0
}

.keyseq kbd:last-child {
  margin-right: 0
}

/* callouts */
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background: rgba(0, 0, 0, .8);
  -webkit-border-radius: 50%;
  border-radius: 50%;
  text-align: center;
  font-size: .75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold
}

.conum[data-value] * {
  color: #fff !important
}

.conum[data-value] + b {
  display: none
}

.conum[data-value]:after {
  content: attr(data-value)
}

pre .conum[data-value] {
  position: relative;
  top: -.125em
}

b.conum * {
  color: inherit !important
}

.conum:not([data-value]):empty {
  display: none
}

/* Callout list */
.hdlist > table, .colist > table {
  border: 0;
  background: none
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
  background: none
}

td.hdlist1, td.hdlist2 {
  vertical-align: top;
  padding: 0 .625em
}

td.hdlist1 {
  font-weight: bold;
  padding-bottom: 1.25em
}

/* Disabled from Asciidoctor CSS because it caused callout list to go under the
 * source listing when .stretch is applied (see #335)
 * .literalblock+.colist,.listingblock+.colist{margin-top:-.5em} */
.colist td:not([class]):first-child {
  padding: .4em .75em 0;
  line-height: 1;
  vertical-align: top
}

.colist td:not([class]):first-child img {
  max-width: none
}

.colist td:not([class]):last-child {
  padding: .25em 0
}

/* Override Asciidoctor CSS that causes issues with reveal.js features */
.reveal .hljs table {
  border: 0
}

/* Callout list rows would have a bottom border with some reveal.js themes (see #335) */
.reveal .colist > table th, .reveal .colist > table td {
  border-bottom: 0
}

/* Fixes line height with Highlight.js source listing when linenums enabled (see #331) */
.reveal .hljs table thead tr th, .reveal .hljs table tfoot tr th, .reveal .hljs table tbody tr td, .reveal .hljs table tr td, .reveal .hljs table tfoot tr td {
  line-height: inherit
}

/* Columns layout */
.columns .slide-content {
  display: flex;
}

.columns.wrap .slide-content {
  flex-wrap: wrap;
}

.columns.is-vcentered .slide-content {
  align-items: center;
}

.columns .slide-content > .column {
  display: block;
  flex-basis: 0;
  flex-grow: 1;
  flex-shrink: 1;
}

.columns .slide-content > .column > * {
  padding: .75rem;
}

/* See #353 */
.columns.wrap .slide-content > .column {
  flex-basis: auto;
}

.columns .slide-content > .column.is-full {
  flex: none;
  width: 100%;
}

.columns .slide-content > .column.is-four-fifths {
  flex: none;
  width: 80%;
}

.columns .slide-content > .column.is-three-quarters {
  flex: none;
  width: 75%;
}

.columns .slide-content > .column.is-two-thirds {
  flex: none;
  width: 66.6666%;
}

.columns .slide-content > .column.is-three-fifths {
  flex: none;
  width: 60%;
}

.columns .slide-content > .column.is-half {
  flex: none;
  width: 50%;
}

.columns .slide-content > .column.is-two-fifths {
  flex: none;
  width: 40%;
}

.columns .slide-content > .column.is-one-third {
  flex: none;
  width: 33.3333%;
}

.columns .slide-content > .column.is-one-quarter {
  flex: none;
  width: 25%;
}

.columns .slide-content > .column.is-one-fifth {
  flex: none;
  width: 20%;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.text-left {
  text-align: left !important
}

.text-right {
  text-align: right !important
}

.text-center {
  text-align: center !important
}

.text-justify {
  text-align: justify !important
}

.footnotes {
  border-top: 1px solid rgba(0, 0, 0, 0.2);
  padding: 0.5em 0 0 0;
  font-size: 0.65em;
  margin-top: 4em;
}
</style><script type="text/x-mathjax-config">MathJax.Hub.Config({
tex2jax: {
  inlineMath: [["\\(", "\\)"]],
  displayMath: [["\\[", "\\]"]],
  ignoreClass: "nostem|nolatexmath"
},
asciimath2jax: {
  delimiters: [["\\$", "\\$"]],
  ignoreClass: "nostem|noasciimath"
},
TeX: { equationNumbers: { autoNumber: "none" } }
});</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script><!--Printing and PDF exports--><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? "reveal.js/css/print/pdf.css" : "reveal.js/css/print/paper.css";
document.getElementsByTagName( 'head' )[0].appendChild( link );</script><link rel="stylesheet" href="css/custom.css"></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title" data-background-image="images/pexels-pixabay-159275.jpg"><h1>Jakże vspaniała maszyna</h1><p class="author"><small>Architektura OpenJDK dla upartych</small></p></section><section id="jarosław_pałka"><h2>Jarosław Pałka</h2><div class="slide-content"><div class="paragraph"><p>Neo4j (a graph database) performance engineer</p></div>
<div class="paragraph"><p>over 20 years with JVM,<br>
since early days of no native threads and,<br>
no JIT and slow as hell GC</p></div>
<div class="paragraph"><p>speaker, coder, architect</p></div>
<div class="paragraph"><p>founder of SegFault conference<br>
godfather of Programistyczna Grupa Rozwoju</p></div></div></section>
<section><section id="abstract"><h2>abstract</h2><div class="slide-content"><div class="paragraph"><p>the original version of this presentation<br>
was created together with Krystian Zybała</p></div><div class="paragraph"><p>and is a monstrous 3 hours deep dive<br>
into fundamental concepts in<br>
OpenJDK</p></div></div></section><section data-background-image="https://media.giphy.com/media/tXL4FHPSnVJ0A/giphy.gif"></section><section><div class="slide-content"><div class="paragraph"><p>you are lucky because we just have 30 minutes ;)</p></div>
<div class="paragraph"><p>goal of this presentation is to kickstart your adventure in OpenJDK</p></div>
<div class="paragraph"><p>I will focus on core components and explaining vocabulary</p></div></div></section><section id="developers_realising_this_jvm_talk" class="highlight_section_title" data-background-image="https://media.giphy.com/media/3o7ZeEZUzRjyvWuuIg/giphy.gif"><h2>Developers realising this JVM talk</h2></section><section id="openjdk"><h2>OpenJDK</h2><div class="slide-content"><div class="paragraph"><p>OpenJDK is an open-source implementation of <a href="https://docs.oracle.com/javase/specs/jvms/se18/html/index.html">The Java® Virtual Machine Specification</a></p></div>
<div class="paragraph"><p>it is also known as HotSpot</p></div>
<div class="paragraph"><p>is an open-sourced Sun&#8217;s original JVM<br>
you can download it from <a href="https://github.com/openjdk/jdk" class="bare">https://github.com/openjdk/jdk</a></p></div></div></section></section>
<section id="if_you_want_to_follow_along"><h2>if you want to follow along</h2><div class="slide-content"><div class="literalblock"><div class="content"><pre>git clone https://github.com/openjdk/jdk18
cd jdk18
chmod +x configure
// read doc/building.md and install required dependencies
./configure // make sure your java points to JDK 18 or 17, this is required for boot JDK
make images
make vscode-project // import project workspace into VSCode</pre></div></div></div></section>
<section id="abstract_2"><h2>abstract</h2><div class="slide-content"><div class="ulist"><ul><li><p>loading and verifying bytecode</p></li><li><p>bytecode interpreter</p></li><li><p>time for just-in-time compiler</p></li><li><p>safepoints and how we stop the world</p></li><li><p>garbage collector black magic</p></li></ul></div></div></section>
<section><section id="loading_and_verifying_bytecode"><h2>loading and verifying bytecode</h2><div class="slide-content"><div class="paragraph"><p>OpenJDK HotSpot doesn&#8217;t know and understand Java<br>
(actually they are separate specifications)</p></div><div class="paragraph"><p>but it understands bytecode ;)</p></div></div></section><section id="loading_bytecode"><h2>loading bytecode</h2><div class="slide-content"><div class="paragraph"><p>there are few things that happen, during this process:</p></div>
<div class="ulist"><ul><li><p>parsing bytecode streams</p></li><li><p>verification of bytecode</p></li><li><p>linking of call-sites (except <em>invokedynamic</em>)</p></li><li><p>allocating <code>Class</code> instance</p></li></ul></div></div></section><section><div class="slide-content"><div class="paragraph"><p>you can find entry point in <code>src/hotspot/share/prims/jvm.cpp::jvm_lookup_define_class</code></p></div>
<div class="paragraph"><p>but real stuff happens in <code>SystemDictionary::resolve_class_from_stream</code></p></div></div></section><section id="verify"><h2>verify?</h2><div class="slide-content"><div class="paragraph"><p>anybody can generate classfile, we should not trust it<br>
it is a process that makes sure bytecode makes sens<br>
(some of the checks happen in <code>ClassFileParser</code>)</p></div>
<div class="paragraph"><p><code>src/hotspot/share/classfile/verifier.cpp</code></p></div>
<div class="paragraph"><p>for example if things on stack, match method parameters<br>
or jumps are to valid instructions</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>JVM requires all classes that are loaded to be verified,<br>
in order to maintain the security of the sandbox<br>
and ensure that the code is safe to optimize</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>it uses a structure called <code>StackMapTable</code>,<br>
which is required to be present in class files</p></div>
<div class="paragraph"><p>it keeps information on what things are on stack<br>
and local variable tables<br>
at specific bci (bytecode index)</p></div></div></section></section>
<section><section id="bytecode_interpreter"><h2>bytecode interpreter</h2><div class="slide-content"><div class="paragraph"><p>this isn&#8217;t actual all that simple, because we have two different interpreters</p></div><div class="ulist"><ul><li><p>high level language version (aka c++ interpreter), actual interpretation of bytecodes,</p></li><li><p>assembly language version (aka template interpreter), generation of assembly code that creates and manages interpreter runtime frames</p></li></ul></div></div></section><section><div class="slide-content"><div class="paragraph"><p>src/hotspot/share/interpreter/abstractInterpreter.hpp</p></div>
<div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">// This file contains the platform-independent parts
// of the abstract interpreter and the abstract interpreter generator.

// Organization of the interpreter(s). There exists two different interpreters in hotpot
// an assembly language version (aka template interpreter) and a high level language version
// (aka c++ interpreter). Th division of labor is as follows:

// Template Interpreter          Zero Interpreter       Functionality
//
// templateTable*                bytecodeInterpreter*   actual interpretation of bytecodes
//
// templateInterpreter*          zeroInterpreter*       generation of assembly code that creates
//                                                      and manages interpreter runtime frames.
//</code></pre></div></div></div></section><section id="a_word_about_zero_jvm"><h2>a word about "zero" JVM</h2><div class="slide-content"><div class="paragraph"><p>a "zero" JVM is a version of JVM which with minimal (in a perfect world "zero") set of changes will run on new architecture and operating system</p></div>
<div class="paragraph"><p>it means as long GCC (in general C compiler) works on this architecture, JVM
will work there (of course only in interpreted mode)</p></div>
<div class="paragraph"><p>it doesn&#8217;t mean Java will work there, only JVM (mindfuck)</p></div></div></section><section id="static_void_runinterpreterstate_istate" data-background-image="https://media.giphy.com/media/JUwT5qRmpFjqOhCLAB/giphy.gif"><h2>static void run(interpreterState istate);</h2></section><section><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">  intptr_t*        topOfStack = (intptr_t *)istate-&gt;stack(); /* access with STACK macros */
  address          pc = istate-&gt;bcp();
  jubyte opcode;
  intptr_t*        locals = istate-&gt;locals();
  ConstantPoolCache*    cp = istate-&gt;constants(); // method()-&gt;constants()-&gt;cache()
#ifdef LOTS_OF_REGS
  JavaThread*      THREAD = istate-&gt;thread();
#else</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>interpreter uses messages to communicate with itself :)<br>
and with frame manager (aka interpreter generator)</p></div>
<div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">    enum messages {
         no_request = 0,            // unused
         initialize,                // Perform one time interpreter initializations (assumes all switches set)
         // status message to C++ interpreter
         method_entry,              // initial method entry to interpreter
         method_resume,             // frame manager response to return_from_method request (assuming a frame to resume)
         deopt_resume,              // returning from a native call into a deopted frame
         deopt_resume2,             // deopt resume as a result of a PopFrame
         got_monitors,              // frame manager response to more_monitors request
         rethrow_exception,         // unwinding and throwing exception
         // requests to frame manager from C++ interpreter
         call_method,               // request for new frame from interpreter, manager responds with method_entry
         return_from_method,        // request from interpreter to unwind, manager responds with method_continue
         more_monitors,             // need a new monitor
         throwing_exception,        // unwind stack and rethrow
         popping_frame,             // unwind call and retry call
         do_osr,                    // request this invocation be OSR's
         early_return               // early return as commanded by jvmti
    };</code></pre></div></div></div></section><section><div class="slide-content"><div class="imageblock"><img src="images/diag-881d8feb395c9a96277466fbe9300ebc.png" alt="Diagram"></div></div></section><section id="method_and_call_entry_point"><h2>method and call entry point</h2><div class="slide-content"><div class="paragraph"><p>a method in JVM can be either interpreted or compiled<br>
(to complete a picture it can also be native or intrinsic)</p></div>
<div class="paragraph"><p>from an interpreted method you can call either<br>
other interpreted or compiled method<br>
but how do you know if method has been compiled?<br>
and how do you handle different logic to call interpreted vs compiled?</p></div></div></section><section><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">// src/hotspot/share/oops/method.hpp:Method

// Entry point for calling both from and to the interpreter.
  address _i2i_entry;           // All-args-on-stack calling convention
  // Entry point for calling from compiled code, to compiled code if it exists
  // or else the interpreter.
  volatile address _from_compiled_entry;        // Cache of: _code ? _code-&gt;entry_point() : _adapter-&gt;c2i_entry()
  // The entry point for calling both from and to compiled code is
  // "_code-&gt;entry_point()".  Because of tiered compilation and de-opt, this
  // field can come and go.  It can transition from NULL to not-null at any
  // time (whenever a compile completes).  It can transition from not-null to
  // NULL only at safepoints (because of a de-opt).
  CompiledMethod* volatile _code;                       // Points to the corresponding piece of native code
  volatile address           _from_interpreted_entry; // Cache of _code ? _adapter-&gt;i2c_entry() : _i2i_entry</code></pre></div></div></div></section><section id="frames"><h2>frames</h2><div class="slide-content"><div class="paragraph"><p>we have two kinds of frames, physical frames (aka frames) and virtual frames (aka vframes)</p></div></div></section><section id="physical_frame"><h2>physical frame</h2></section><section><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">class frame {
 private:
  // Instance variables:
  intptr_t* _sp; // stack pointer (from Thread::last_Java_sp)
  address   _pc; // program counter (the next instruction after the call)

  CodeBlob* _cb; // CodeBlob that "owns" pc
  enum deopt_state {
    not_deoptimized,
    is_deoptimized,
    unknown
  };

  deopt_state _deopt_state;
};</code></pre></div></div></div></section><section id="code_blob" class="highlight_section_title" data-background-image="https://media.giphy.com/media/y70jyPYRIL1sZOcRJF/giphy.gif"><h2>code blob</h2></section><section><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">// CodeBlob - superclass for all entries in the CodeCache.
//
// Subtypes are:
//  CompiledMethod       : Compiled Java methods (include method that calls to native code)
//   nmethod             : JIT Compiled Java methods
//  RuntimeBlob          : Non-compiled method code; generated glue code
//   BufferBlob          : Used for non-relocatable code such as interpreter, stubroutines, etc.
//    AdapterBlob        : Used to hold C2I/I2C adapters
//    VtableBlob         : Used for holding vtable chunks
//    MethodHandlesAdapterBlob : Used to hold MethodHandles adapters
//    OptimizedEntryBlob : Used for upcalls from native code
//   RuntimeStub         : Call to VM runtime methods
//   SingletonBlob       : Super-class for all blobs that exist in only one instance
//    DeoptimizationBlob : Used for deoptimization
//    ExceptionBlob      : Used for stack unrolling
//    SafepointBlob      : Used to handle illegal instruction exceptions
//    UncommonTrapBlob   : Used to handle uncommon traps
//
//
// Layout : continuous in the CodeCache
//   - header
//   - relocation
//   - content space
//     - instruction space
//   - data space</code></pre></div></div></div></section><section id="virtual_frame"><h2>virtual frame</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">// vframes are virtual stack frames representing source level activations.
// A single frame may hold several source level activations in the case of
// optimized code. The debugging stored with the optimized code enables
// us to unfold a frame as a stack of vframes.
// A cVFrame represents an activation of a non-java method.

// The vframe inheritance hierarchy:
// - vframe
//   - javaVFrame
//     - interpretedVFrame
//     - compiledVFrame     ; (used for both compiled Java methods and native stubs)
//   - externalVFrame
//     - entryVFrame        ; special frame created when calling Java from C</code></pre></div></div></div></section></section>
<section><section id="time_for_just_in_time_compiler"><h2>time for just-in-time compiler</h2><div class="slide-content"><div class="paragraph"><p>JIT (just-in-time compiler) in JVM was a major step in the world of JITs</p></div><div class="ulist"><ul><li><p>profile guided optimizations</p></li><li><p>speculating compilation (with traps and deoptimizations)</p></li><li><p>on-stack replacement</p></li><li><p>used SSA (single static assigment) form and "sea of nodes" (developed by Cliff Click)</p></li></ul></div></div></section><section id="it_takes_two"><h2>it takes two</h2><div class="slide-content"><div class="paragraph"><p>this isn&#8217;t actual all that simple,<br>
because we have two different compilers<br>
(plus GraalVM, thanks to JVMCI (JVM compiler interface))</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>yes, you can write your own compilers as plugins</p></div>
<div class="paragraph"><p>(only if your are rich, <a href="https://www.azul.com/products/components/falcon-jit-compiler/">Azul Platform Prime’s Falcon JIT Compiler</a>)</p></div></div></section><section id="hotspot_compilers"><h2>HotSpot compilers</h2><div class="slide-content"><div class="paragraph"><p>C1 (aka client compiler) was originally design for better startup times, but it doesn&#8217;t generate optimal code</p></div>
<div class="paragraph"><p>C2 (aka server compiler) is slower, but generates quality, optimized, state of the art native code</p></div>
<div class="paragraph"><p>at the moment we have tiered compilation enabled by default<br>
(using both compilers)</p></div></div></section><section id="c2_code" class="highlight_section_title" data-background-image="https://media.giphy.com/media/zy9wp81bCIyzu/giphy.gif"><h2>C2 code</h2></section><section id="need_for_speed" class="highlight_section_title" data-background-image="https://media.giphy.com/media/xTiTnFM0Cr2xcGUsVy/giphy.gif"><h2>need for speed</h2></section><section><div class="slide-content"><div class="paragraph"><p>so, who decides when code gets compiled?<br>
(and deoptimized)</p></div>
<div class="paragraph"><p><code>src/hotspot/share/compiler/compilationPolicy.hpp</code></p></div>
<div class="paragraph"><p>let&#8217;s disassemble the first parts</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>The system supports 5 execution levels:</p></div>
<div class="ulist"><ul><li><p>level 0 - interpreter</p></li><li><p>level 1 - C1 with full optimization (no profiling)</p></li><li><p>level 2 - C1 with invocation and backedge counters</p></li><li><p>level 3 - C1 with full profiling (level 2 + MDO)</p></li><li><p>level 4 - C2</p></li></ul></div></div></section><section id="wait_wat_profiling"><h2>wait? wat? profiling?</h2><div class="slide-content"><div class="paragraph"><p>JVM injects (both in interpreted and compiled code) instrumentation,
to record how your code is used<br></p></div>
<div class="paragraph"><p>not only how often method is called (aka counters)<br>
but also taken branches, type profile, loop sizes and much more</p></div></div></section><section id="backedge_counters"><h2>backedge counters?</h2><div class="slide-content"><div class="paragraph"><p>invocation counter are pretty obvious</p></div>
<div class="paragraph"><p>what the hell is backedge counter?</p></div>
<div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">for(;;){

} // increment backedge counter</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Levels 0, 2 and 3 periodically notify the runtime about the current value of the counters (invocation counters and backedge counters). The frequency of these notifications is different at each level. These notifications are used by the policy to decide what transition to make.</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>when compilation policy decides that method should be compiled, it puts a method (a compile task) onto one of the compilation queues</p></div>
<div class="paragraph"><p>by default C1 queue has one worker threads and C2 has two (it all depends on your machine)</p></div></div></section><section id="speculating_jit" data-background-image="https://media.giphy.com/media/Lw39ENuDr0SdO/giphy.gif"><h2>speculating JIT</h2></section><section id="your_code"><h2>your code</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-Java hljs" data-noescape="true" data-lang="Java">if(){
  // lots of code
} else {
  // even more code
}</code></pre></div></div></div></section><section id="your_code_compiled"><h2>your code, compiled</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-Java hljs" data-noescape="true" data-lang="Java">if(){
  // lots of code
} else {
  uncommon_trap();
}</code></pre></div></div></div></section><section id="uncommon_trap"><h2>uncommon trap</h2><div class="slide-content"><div class="paragraph"><p>it is a place in code of your compiled method<br>
which was not compiled &amp; optimized<br>
because of poor ROI<br>
(dad joke)</p></div>
<div class="paragraph"><p>which calls into JVM <code>Deoptimization::uncommon_trap</code></p></div>
<div class="paragraph"><p><code>src/hotspot/share/runtime/deoptimization.hpp</code></p></div></div></section><section id="deopt_reason_action"><h2>deopt reason &amp; action</h2><div class="slide-content"><div class="paragraph"><p>DepotReason is a condition that caused deoptimization</p></div>
<div class="ulist"><ul><li><p>unexpected null or zero divisor</p></li><li><p>unexpected array index</p></li><li><p>unexpected object class</p></li><li><p>unexpected object class in bimorphic inlining</p></li></ul></div></div></section><section id="deopt_action"><h2>deopt action</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">  // What action must be taken by the runtime?
  enum DeoptAction {
    Action_none,                  // just interpret, do not invalidate nmethod
    Action_maybe_recompile,       // recompile the nmethod; need not invalidate
    Action_reinterpret,           // invalidate the nmethod, reset IC, maybe recompile
    Action_make_not_entrant,      // invalidate the nmethod, recompile (probably)
    Action_make_not_compilable,   // invalidate the nmethod and do not compile
    Action_LIMIT
    // Note:  Keep this enum in sync. with _trap_action_name.
  };</code></pre></div></div></div></section><section id="invalidate"><h2>invalidate?</h2><div class="slide-content"><div class="paragraph"><p>yes, we have queues and caches in OpenJDK compiler code ;)<br></p></div>
<div class="paragraph"><p>generated code (which are not only compiled methods)<br>
is kept in compile cache<br>
(outside of JVM heap)</p></div></div></section><section id="not_entrant"><h2>not entrant?</h2><div class="slide-content"><div class="paragraph"><p>sometimes, when things go wrong,<br>
compiled method is marked not entrant<br>
it means no other thread can enter it,<br>
and later removed from code cache</p></div></div></section><section id="so_what_is_actually_happening"><h2>so what is actually happening?</h2><div class="slide-content"><div class="ulist"><ul><li><p>your compile frame needs to be converted into an interpreter frame</p></li><li><p>compiled method can be marked as not entrant, or even invalidated from code cache</p></li><li><p>invocation counters and method data can be reset</p></li></ul></div></div></section></section>
<section><section id="safepoints_and_how_we_stop_the_world"><h2>safepoints and how we stop the world</h2><div class="slide-content"><div class="paragraph"><p>safepoints (to be precise global safepoint) is a mechanism<br>
which is used to stop application threads when it is needed</p></div><div class="paragraph"><p>garbage collection cycle<br>
revocation of biased locking<br>
and other VM operations</p></div></div></section><section id="dirty_little_secret"><h2>dirty little secret</h2><div class="slide-content"><div class="paragraph"><p>you can think about safepoint as a global flag,
which is polled by some code, sometimes</p></div>
<div class="paragraph"><p>and if this flag ise true, application thread has to stop</p></div></div></section><section id="show_me_the_code"><h2>show me the code</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">class SafepointSynchronize : AllStatic {
 public:
  enum SynchronizeState {
      _not_synchronized = 0,                   // Threads not synchronized at a safepoint. Keep this value 0.
      _synchronizing    = 1,                   // Synchronizing in progress
      _synchronized     = 2                    // All Java threads are running in native, blocked in OS or stopped at safepoint.
                                               // VM thread and any NonJavaThread may be running.
  };
  // Threads might read this flag directly, without acquiring the Threads_lock:
  static volatile SynchronizeState _state;
};</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>JVM injects safepoint poll at</p></div>
<div class="ulist"><ul><li><p>exit of method</p></li><li><p>loop backedge</p></li><li><p>in interpret code</p></li><li><p>JNI critical blocks</p></li></ul></div></div></section><section><div class="slide-content"><div class="paragraph"><p>this means not all threads stop at the same time ;)</p></div>
<div class="paragraph"><p>TTSP (time to safepoint) is a metric you are looking for</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>of course Java thread needs to notify global safepoint mechanism,
that is has stopped at safepoint</p></div>
<div class="paragraph"><p><code>src/hotspot/share/runtime/safepoint.hpp</code></p></div></div></section></section>
<section><section id="garbage_collector_black_magic"><h2>garbage collector black magic</h2><div class="slide-content"><div class="paragraph"><p>OpenJDK garbage collectors implement tracing collectors,
as you can expect GCs in OpenJDK are pluggable</p></div><div class="paragraph"><p>three key phases:</p></div><div class="ulist"><ul><li><p>reachability analisys from GC roots,</p></li><li><p>swapping unreachable objects</p></li><li><p>compacting memory (optional)</p></li></ul></div></div></section><section id="gc_roots"><h2>GC roots?</h2><div class="slide-content"><div class="paragraph"><p>GC roots are objects which are always reachable,<br>
so we can safely start reachability analysis,<br>
as object reachable from GC roots are reachable too</p></div>
<div class="ulist"><ul><li><p>local variables</p></li><li><p>static fields</p></li><li><p>threads</p></li><li><p>JNI references</p></li></ul></div></div></section><section id="oopmap"><h2>OopMap</h2><div class="slide-content"><div class="paragraph"><p>things get complicated for compiled code,<br>
as references can be store in CPU registers</p></div>
<div class="paragraph"><p>OopMap is a data structure<br>
which helps track references to objects</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>There are three kinds of OopMaps:</p></div>
<div class="ulist"><ul><li><p>OopMaps for interpreted methods. They are computed lazily, i.e. when GC happens, by analyzing bytecode flow. InterpreterOopMaps are stored in OopMapCache.</p></li><li><p>OopMaps for JIT-compiled methods. They are generated during JIT-compilation and kept along with the compiled code so that VM can quickly find by instruction address the stack locations and the registers where the object references are held.</p></li><li><p>OopMaps for generated shared runtime stubs. These maps are constructed manually by the developers - authors of these runtime stubs.</p></li></ul></div>
<div class="paragraph"><p>for more insights <code>src/hotspot/share/oops/generateOopMap.hpp</code></p></div></div></section><section id="allocation"><h2>allocation?</h2><div class="slide-content"><div class="paragraph"><p>yes, garbage collectors are responsible for object allocation too</p></div>
<div class="paragraph"><p>in most cases they use technique called TLAB (Thread-Local Allocation Buffer)<br>
<code>src/hotspot/share/gc/shared/threadLocalAllocBuffer.hpp</code></p></div>
<div class="paragraph"><p>in short every thread gets its own space in the shared heap,<br>
so it doesn&#8217;t have to compete with others</p></div></div></section><section id="tlab"><h2>TLAB</h2><div class="slide-content"><div class="paragraph"><p>TLABs are resized during garbage collection,<br>
to better respond to allocation pressure</p></div>
<div class="paragraph"><p>if object is bigger then buffer size,<br>
it is allocated in shared space</p></div></div></section><section id="who_needs_barriers"><h2>who needs barriers ;)</h2><div class="slide-content"><div class="paragraph"><p>things get complicated when we want<br>
to do some of the GC work<br>
concurrently with your code</p></div>
<div class="paragraph"><p>like reachability analisys,<br>
swapping,<br>
and compaction</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>we need a mechanism to notify JVM<br>
when references changes in our code</p></div>
<div class="paragraph"><p>barriers are small assembly code snipets,<br>
injected on load or store of reference</p></div>
<div class="paragraph"><p>(this needs cooperation between GC, interpreter and compilers)</p></div>
<div class="paragraph"><p><code>src/hotspot/share/gc/shared/barrierSet.hpp</code></p></div></div></section></section>
<section id="thank_you"><h2>thank you!</h2></section></div></div><script src="reveal.js/js/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
});

// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  // Display presentation control arrows
  controls: false,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: false,
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Add the current slide number to the URL hash so that reloading the
  // page/copying the URL will return you to the same slide
  hash: false,
  // Push each slide change to the browser history. Implies `hash: true`
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Disables the default reveal.js slide layout so that you can use custom CSS layout
  disableLayout: false,
  // Vertical centering of slides
  center: true,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // See https://github.com/hakimel/reveal.js/#navigation-mode
  navigationMode: 'default',
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Global override for preloading lazy-loaded iframes
  // - null: Iframes with data-src AND data-preload will be loaded when within
  //   the viewDistance, iframes with only data-src will be loaded when visible
  // - true: All iframes with data-src will be loaded when within the viewDistance
  // - false: All iframes with data-src will be loaded only when visible
  preloadIframes: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Specify the total time in seconds that is available to
  // present.  If this is set to a nonzero value, the pacing
  // timer will work out the time available for each slide,
  // instead of using the defaultTiming value
  totalTime: 0,
  // Specify the minimum amount of time you want to allot to
  // each slide, if using the totalTime calculation method.  If
  // the automated time allocation causes slide pacing to fall
  // below this threshold, then you will see an alert in the
  // speaker notes window
  minimumTimePerSlide: 0,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hide cursor if inactive
  hideInactiveCursor: true,
  // Time before the cursor is hidden (in ms)
  hideCursorTime: 5000,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'slide',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Number of slides away from the current that are visible on mobile
  // devices. It is advisable to set this to a lower number than
  // viewDistance in order to save resources.
  mobileViewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 1920,
  height: 1080,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // PDF Export Options
  // Put each fragment on a separate page
  pdfSeparateFragments: true,
  // For slides that do not fit on a page, max number of pages
  pdfMaxPagesPerSlide: 1,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
      { src: 'reveal.js/plugin/notes/notes.js', async: true }
  ],

  

});</script><script>var dom = {};
dom.slides = document.querySelector('.reveal .slides');

function getRemainingHeight(element, slideElement, height) {
  height = height || 0;
  if (element) {
    var newHeight, oldHeight = element.style.height;
    // Change the .stretch element height to 0 in order find the height of all
    // the other elements
    element.style.height = '0px';
    // In Overview mode, the parent (.slide) height is set of 700px.
    // Restore it temporarily to its natural height.
    slideElement.style.height = 'auto';
    newHeight = height - slideElement.offsetHeight;
    // Restore the old height, just in case
    element.style.height = oldHeight + 'px';
    // Clear the parent (.slide) height. .removeProperty works in IE9+
    slideElement.style.removeProperty('height');
    return newHeight;
  }
  return height;
}

function layoutSlideContents(width, height) {
  // Handle sizing of elements with the 'stretch' class
  toArray(dom.slides.querySelectorAll('section .stretch')).forEach(function (element) {
    // Determine how much vertical space we can use
    var limit = 5; // hard limit
    var parent = element.parentNode;
    while (parent.nodeName !== 'SECTION' && limit > 0) {
      parent = parent.parentNode;
      limit--;
    }
    if (limit === 0) {
      // unable to find parent, aborting!
      return;
    }
    var remainingHeight = getRemainingHeight(element, parent, height);
    // Consider the aspect ratio of media elements
    if (/(img|video)/gi.test(element.nodeName)) {
      var nw = element.naturalWidth || element.videoWidth, nh = element.naturalHeight || element.videoHeight;
      var es = Math.min(width / nw, remainingHeight / nh);
      element.style.width = (nw * es) + 'px';
      element.style.height = (nh * es) + 'px';
    } else {
      element.style.width = width + 'px';
      element.style.height = remainingHeight + 'px';
    }
  });
}

function toArray(o) {
  return Array.prototype.slice.call(o);
}

Reveal.addEventListener('slidechanged', function () {
  layoutSlideContents(1920, 1080)
});
Reveal.addEventListener('ready', function () {
  layoutSlideContents(1920, 1080)
});
Reveal.addEventListener('resize', function () {
  layoutSlideContents(1920, 1080)
});</script><link rel="stylesheet" href="reveal.js/lib/css/monokai.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>

<script>

/* highlightjs-line-numbers.js 2.6.0 | (C) 2018 Yauheni Pakala | MIT License | github.com/wcoder/highlightjs-line-numbers.js */
/* Edited by Hakim for reveal.js; removed async timeout */
!function(n,e){"use strict";function t(){var n=e.createElement("style");n.type="text/css",n.innerHTML=g(".{0}{border-collapse:collapse}.{0} td{padding:0}.{1}:before{content:attr({2})}",[v,L,b]),e.getElementsByTagName("head")[0].appendChild(n)}function r(t){"interactive"===e.readyState||"complete"===e.readyState?i(t):n.addEventListener("DOMContentLoaded",function(){i(t)})}function i(t){try{var r=e.querySelectorAll("code.hljs,code.nohighlight");for(var i in r)r.hasOwnProperty(i)&&l(r[i],t)}catch(o){n.console.error("LineNumbers error: ",o)}}function l(n,e){"object"==typeof n&&f(function(){n.innerHTML=s(n,e)})}function o(n,e){if("string"==typeof n){var t=document.createElement("code");return t.innerHTML=n,s(t,e)}}function s(n,e){e=e||{singleLine:!1};var t=e.singleLine?0:1;return c(n),a(n.innerHTML,t)}function a(n,e){var t=u(n);if(""===t[t.length-1].trim()&&t.pop(),t.length>e){for(var r="",i=0,l=t.length;i<l;i++)r+=g('<tr><td class="{0}"><div class="{1} {2}" {3}="{5}"></div></td><td class="{4}"><div class="{1}">{6}</div></td></tr>',[j,m,L,b,p,i+1,t[i].length>0?t[i]:" "]);return g('<table class="{0}">{1}</table>',[v,r])}return n}function c(n){var e=n.childNodes;for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];h(r.textContent)>0&&(r.childNodes.length>0?c(r):d(r.parentNode))}}function d(n){var e=n.className;if(/hljs-/.test(e)){for(var t=u(n.innerHTML),r=0,i="";r<t.length;r++){var l=t[r].length>0?t[r]:" ";i+=g('<span class="{0}">{1}</span>\n',[e,l])}n.innerHTML=i.trim()}}function u(n){return 0===n.length?[]:n.split(y)}function h(n){return(n.trim().match(y)||[]).length}function f(e){e()}function g(n,e){return n.replace(/{(\d+)}/g,function(n,t){return e[t]?e[t]:n})}var v="hljs-ln",m="hljs-ln-line",p="hljs-ln-code",j="hljs-ln-numbers",L="hljs-ln-n",b="data-line-number",y=/\r\n|\r|\n/g;n.hljs?(n.hljs.initLineNumbersOnLoad=r,n.hljs.lineNumbersBlock=l,n.hljs.lineNumbersValue=o,t()):n.console.error("highlight.js not detected!")}(window,document);

/**
 * This reveal.js plugin is wrapper around the highlight.js
 * syntax highlighting library.
 */
(function( root, factory ) {
  if (typeof define === 'function' && define.amd) {
    root.RevealHighlight = factory();
  } else if( typeof exports === 'object' ) {
    module.exports = factory();
  } else {
    // Browser globals (root is window)
    root.RevealHighlight = factory();
  }
}( this, function() {

  // Function to perform a better "data-trim" on code snippets
  // Will slice an indentation amount on each line of the snippet (amount based on the line having the lowest indentation length)
  function betterTrim(snippetEl) {
    // Helper functions
    function trimLeft(val) {
      // Adapted from https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/Trim#Polyfill
      return val.replace(/^[\s\uFEFF\xA0]+/g, '');
    }
    function trimLineBreaks(input) {
      var lines = input.split('\n');

      // Trim line-breaks from the beginning
      for (var i = 0; i < lines.length; i++) {
        if (lines[i].trim() === '') {
          lines.splice(i--, 1);
        } else break;
      }

      // Trim line-breaks from the end
      for (var i = lines.length-1; i >= 0; i--) {
        if (lines[i].trim() === '') {
          lines.splice(i, 1);
        } else break;
      }

      return lines.join('\n');
    }

    // Main function for betterTrim()
    return (function(snippetEl) {
      var content = trimLineBreaks(snippetEl.innerHTML);
      var lines = content.split('\n');
      // Calculate the minimum amount to remove on each line start of the snippet (can be 0)
      var pad = lines.reduce(function(acc, line) {
        if (line.length > 0 && trimLeft(line).length > 0 && acc > line.length - trimLeft(line).length) {
          return line.length - trimLeft(line).length;
        }
        return acc;
      }, Number.POSITIVE_INFINITY);
      // Slice each line with this amount
      return lines.map(function(line, index) {
        return line.slice(pad);
      })
        .join('\n');
    })(snippetEl);
  }

  var RevealHighlight = {

    HIGHLIGHT_STEP_DELIMITER: '|',
    HIGHLIGHT_LINE_DELIMITER: ',',
    HIGHLIGHT_LINE_RANGE_DELIMITER: '-',

    init: function() {

      // Read the plugin config options and provide fallbacks
      var config = Reveal.getConfig().highlight || {};
      config.highlightOnLoad = typeof config.highlightOnLoad === 'boolean' ? config.highlightOnLoad : true;
      config.escapeHTML = typeof config.escapeHTML === 'boolean' ? config.escapeHTML : true;

      [].slice.call( document.querySelectorAll( '.reveal pre code' ) ).forEach( function( block ) {

        // Trim whitespace if the "data-trim" attribute is present
        if( block.hasAttribute( 'data-trim' ) && typeof block.innerHTML.trim === 'function' ) {
          block.innerHTML = betterTrim( block );
        }

        // Escape HTML tags unless the "data-noescape" attrbute is present
        if( config.escapeHTML && !block.hasAttribute( 'data-noescape' )) {
          block.innerHTML = block.innerHTML.replace( /</g,"&lt;").replace(/>/g, '&gt;' );
        }

        // Re-highlight when focus is lost (for contenteditable code)
        block.addEventListener( 'focusout', function( event ) {
          hljs.highlightBlock( event.currentTarget );
        }, false );

        if( config.highlightOnLoad ) {
          RevealHighlight.highlightBlock( block );
        }
      } );

    },

    /**
     * Highlights a code block. If the <code> node has the
     * 'data-line-numbers' attribute we also generate slide
     * numbers.
     *
     * If the block contains multiple line highlight steps,
     * we clone the block and create a fragment for each step.
     */
    highlightBlock: function( block ) {

      hljs.highlightBlock( block );

      // Don't generate line numbers for empty code blocks
      if( block.innerHTML.trim().length === 0 ) return;

      if( block.hasAttribute( 'data-line-numbers' ) ) {
        hljs.lineNumbersBlock( block, { singleLine: true } );

        // If there is at least one highlight step, generate
        // fragments
        var highlightSteps = RevealHighlight.deserializeHighlightSteps( block.getAttribute( 'data-line-numbers' ) );
        if( highlightSteps.length > 1 ) {

          // If the original code block has a fragment-index,
          // each clone should follow in an incremental sequence
          var fragmentIndex = parseInt( block.getAttribute( 'data-fragment-index' ), 10 );
          if( typeof fragmentIndex !== 'number' || isNaN( fragmentIndex ) ) {
            fragmentIndex = null;
          }

          // Generate fragments for all steps except the original block
          highlightSteps.slice(1).forEach( function( highlight ) {

            var fragmentBlock = block.cloneNode( true );
            fragmentBlock.setAttribute( 'data-line-numbers', RevealHighlight.serializeHighlightSteps( [ highlight ] ) );
            fragmentBlock.classList.add( 'fragment' );
            block.parentNode.appendChild( fragmentBlock );
            RevealHighlight.highlightLines( fragmentBlock );

            if( typeof fragmentIndex === 'number' ) {
              fragmentBlock.setAttribute( 'data-fragment-index', fragmentIndex );
              fragmentIndex += 1;
            }
            else {
              fragmentBlock.removeAttribute( 'data-fragment-index' );
            }

          } );

          block.removeAttribute( 'data-fragment-index' )
          block.setAttribute( 'data-line-numbers', RevealHighlight.serializeHighlightSteps( [ highlightSteps[0] ] ) );

        }

        RevealHighlight.highlightLines( block );

      }

    },

    /**
     * Visually emphasize specific lines within a code block.
     * This only works on blocks with line numbering turned on.
     *
     * @param {HTMLElement} block a <code> block
     * @param {String} [linesToHighlight] The lines that should be
     * highlighted in this format:
     * "1" 		= highlights line 1
     * "2,5"	= highlights lines 2 & 5
     * "2,5-7"	= highlights lines 2, 5, 6 & 7
     */
    highlightLines: function( block, linesToHighlight ) {

      var highlightSteps = RevealHighlight.deserializeHighlightSteps( linesToHighlight || block.getAttribute( 'data-line-numbers' ) );

      if( highlightSteps.length ) {

        highlightSteps[0].forEach( function( highlight ) {

          var elementsToHighlight = [];

          // Highlight a range
          if( typeof highlight.end === 'number' ) {
            elementsToHighlight = [].slice.call( block.querySelectorAll( 'table tr:nth-child(n+'+highlight.start+'):nth-child(-n+'+highlight.end+')' ) );
          }
          // Highlight a single line
          else if( typeof highlight.start === 'number' ) {
            elementsToHighlight = [].slice.call( block.querySelectorAll( 'table tr:nth-child('+highlight.start+')' ) );
          }

          if( elementsToHighlight.length ) {
            elementsToHighlight.forEach( function( lineElement ) {
              lineElement.classList.add( 'highlight-line' );
            } );

            block.classList.add( 'has-highlights' );
          }

        } );

      }

    },

    /**
     * Parses and formats a user-defined string of line
     * numbers to highlight.
     *
     * @example
     * RevealHighlight.deserializeHighlightSteps( '1,2|3,5-10' )
     * // [
     * //   [ { start: 1 }, { start: 2 } ],
     * //   [ { start: 3 }, { start: 5, end: 10 } ]
     * // ]
     */
    deserializeHighlightSteps: function( highlightSteps ) {

      // Remove whitespace
      highlightSteps = highlightSteps.replace( /\s/g, '' );

      // Divide up our line number groups
      highlightSteps = highlightSteps.split( RevealHighlight.HIGHLIGHT_STEP_DELIMITER );

      return highlightSteps.map( function( highlights ) {

        return highlights.split( RevealHighlight.HIGHLIGHT_LINE_DELIMITER ).map( function( highlight ) {

          // Parse valid line numbers
          if( /^[\d-]+$/.test( highlight ) ) {

            highlight = highlight.split( RevealHighlight.HIGHLIGHT_LINE_RANGE_DELIMITER );

            var lineStart = parseInt( highlight[0], 10 ),
              lineEnd = parseInt( highlight[1], 10 );

            if( isNaN( lineEnd ) ) {
              return {
                start: lineStart
              };
            }
            else {
              return {
                start: lineStart,
                end: lineEnd
              };
            }

          }
          // If no line numbers are provided, no code will be highlighted
          else {

            return {};

          }

        } );

      } );

    },

    /**
     * Serializes parsed line number data into a string so
     * that we can store it in the DOM.
     */
    serializeHighlightSteps: function( highlightSteps ) {

      return highlightSteps.map( function( highlights ) {

        return highlights.map( function( highlight ) {

          // Line range
          if( typeof highlight.end === 'number' ) {
            return highlight.start + RevealHighlight.HIGHLIGHT_LINE_RANGE_DELIMITER + highlight.end;
          }
          // Single line
          else if( typeof highlight.start === 'number' ) {
            return highlight.start;
          }
          // All lines
          else {
            return '';
          }

        } ).join( RevealHighlight.HIGHLIGHT_LINE_DELIMITER );

      } ).join( RevealHighlight.HIGHLIGHT_STEP_DELIMITER );

    }

  }

  Reveal.registerPlugin( 'highlight', RevealHighlight );

  return RevealHighlight;

}));
        
hljs.initHighlightingOnLoad();
</script></body></html>