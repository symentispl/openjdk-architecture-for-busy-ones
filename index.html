<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"><title>Jakże vspaniała maszyna</title><meta name="author" content="Architektura OpenJDK dla upartych"><link rel="stylesheet" href="reveal.js/css/reset.css"><link rel="stylesheet" href="reveal.js/css/reveal.css"><link rel="stylesheet" href="reveal.js/css/theme/night.css" id="theme"><!--This CSS is generated by the Asciidoctor reveal.js converter to further integrate AsciiDoc's existing semantic with reveal.js--><style type="text/css">.reveal div.right {
  float: right
}

/* listing block */
.reveal .listingblock.stretch > .content {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre > code {
  height: 100%;
  max-height: 100%
}

/* tables */
table {
  border-collapse: collapse;
  border-spacing: 0
}

table {
  margin-bottom: 1.25em;
  border: solid 1px #dedede
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
  padding: .5em .625em .625em;
  font-size: inherit;
  text-align: left
}

table tr th, table tr td {
  padding: .5625em .625em;
  font-size: inherit
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
  display: table-cell;
  line-height: 1.6
}

td.tableblock > .content {
  margin-bottom: 1.25em
}

td.tableblock > .content > :last-child {
  margin-bottom: -1.25em
}

table.tableblock, th.tableblock, td.tableblock {
  border: 0 solid #dedede
}

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock {
  border-width: 0 1px 1px 0
}

table.grid-all > tfoot > tr > .tableblock {
  border-width: 1px 1px 0 0
}

table.grid-cols > * > tr > .tableblock {
  border-width: 0 1px 0 0
}

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock {
  border-width: 0 0 1px
}

table.grid-rows > tfoot > tr > .tableblock {
  border-width: 1px 0 0
}

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child {
  border-right-width: 0
}

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock {
  border-bottom-width: 0
}

table.frame-all {
  border-width: 1px
}

table.frame-sides {
  border-width: 0 1px
}

table.frame-topbot, table.frame-ends {
  border-width: 1px 0
}

.reveal table th.halign-left, .reveal table td.halign-left {
  text-align: left
}

.reveal table th.halign-right, .reveal table td.halign-right {
  text-align: right
}

.reveal table th.halign-center, .reveal table td.halign-center {
  text-align: center
}

.reveal table th.valign-top, .reveal table td.valign-top {
  vertical-align: top
}

.reveal table th.valign-bottom, .reveal table td.valign-bottom {
  vertical-align: bottom
}

.reveal table th.valign-middle, .reveal table td.valign-middle {
  vertical-align: middle
}

table thead th, table tfoot th {
  font-weight: bold
}

tbody tr th {
  display: table-cell;
  line-height: 1.6
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
  font-weight: bold
}

thead {
  display: table-header-group
}

.reveal table.grid-none th, .reveal table.grid-none td {
  border-bottom: 0 !important
}

/* kbd macro */
kbd {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  display: inline-block;
  color: rgba(0, 0, 0, .8);
  font-size: .65em;
  line-height: 1.45;
  background: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em #fff inset;
  margin: 0 .15em;
  padding: .2em .5em;
  vertical-align: middle;
  position: relative;
  top: -.1em;
  white-space: nowrap
}

.keyseq kbd:first-child {
  margin-left: 0
}

.keyseq kbd:last-child {
  margin-right: 0
}

/* callouts */
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background: rgba(0, 0, 0, .8);
  -webkit-border-radius: 50%;
  border-radius: 50%;
  text-align: center;
  font-size: .75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold
}

.conum[data-value] * {
  color: #fff !important
}

.conum[data-value] + b {
  display: none
}

.conum[data-value]:after {
  content: attr(data-value)
}

pre .conum[data-value] {
  position: relative;
  top: -.125em
}

b.conum * {
  color: inherit !important
}

.conum:not([data-value]):empty {
  display: none
}

/* Callout list */
.hdlist > table, .colist > table {
  border: 0;
  background: none
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
  background: none
}

td.hdlist1, td.hdlist2 {
  vertical-align: top;
  padding: 0 .625em
}

td.hdlist1 {
  font-weight: bold;
  padding-bottom: 1.25em
}

/* Disabled from Asciidoctor CSS because it caused callout list to go under the
 * source listing when .stretch is applied (see #335)
 * .literalblock+.colist,.listingblock+.colist{margin-top:-.5em} */
.colist td:not([class]):first-child {
  padding: .4em .75em 0;
  line-height: 1;
  vertical-align: top
}

.colist td:not([class]):first-child img {
  max-width: none
}

.colist td:not([class]):last-child {
  padding: .25em 0
}

/* Override Asciidoctor CSS that causes issues with reveal.js features */
.reveal .hljs table {
  border: 0
}

/* Callout list rows would have a bottom border with some reveal.js themes (see #335) */
.reveal .colist > table th, .reveal .colist > table td {
  border-bottom: 0
}

/* Fixes line height with Highlight.js source listing when linenums enabled (see #331) */
.reveal .hljs table thead tr th, .reveal .hljs table tfoot tr th, .reveal .hljs table tbody tr td, .reveal .hljs table tr td, .reveal .hljs table tfoot tr td {
  line-height: inherit
}

/* Columns layout */
.columns .slide-content {
  display: flex;
}

.columns.wrap .slide-content {
  flex-wrap: wrap;
}

.columns.is-vcentered .slide-content {
  align-items: center;
}

.columns .slide-content > .column {
  display: block;
  flex-basis: 0;
  flex-grow: 1;
  flex-shrink: 1;
}

.columns .slide-content > .column > * {
  padding: .75rem;
}

/* See #353 */
.columns.wrap .slide-content > .column {
  flex-basis: auto;
}

.columns .slide-content > .column.is-full {
  flex: none;
  width: 100%;
}

.columns .slide-content > .column.is-four-fifths {
  flex: none;
  width: 80%;
}

.columns .slide-content > .column.is-three-quarters {
  flex: none;
  width: 75%;
}

.columns .slide-content > .column.is-two-thirds {
  flex: none;
  width: 66.6666%;
}

.columns .slide-content > .column.is-three-fifths {
  flex: none;
  width: 60%;
}

.columns .slide-content > .column.is-half {
  flex: none;
  width: 50%;
}

.columns .slide-content > .column.is-two-fifths {
  flex: none;
  width: 40%;
}

.columns .slide-content > .column.is-one-third {
  flex: none;
  width: 33.3333%;
}

.columns .slide-content > .column.is-one-quarter {
  flex: none;
  width: 25%;
}

.columns .slide-content > .column.is-one-fifth {
  flex: none;
  width: 20%;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.text-left {
  text-align: left !important
}

.text-right {
  text-align: right !important
}

.text-center {
  text-align: center !important
}

.text-justify {
  text-align: justify !important
}

.footnotes {
  border-top: 1px solid rgba(0, 0, 0, 0.2);
  padding: 0.5em 0 0 0;
  font-size: 0.65em;
  margin-top: 4em;
}
</style><script type="text/x-mathjax-config">MathJax.Hub.Config({
tex2jax: {
  inlineMath: [["\\(", "\\)"]],
  displayMath: [["\\[", "\\]"]],
  ignoreClass: "nostem|nolatexmath"
},
asciimath2jax: {
  delimiters: [["\\$", "\\$"]],
  ignoreClass: "nostem|noasciimath"
},
TeX: { equationNumbers: { autoNumber: "none" } }
});</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script><!--Printing and PDF exports--><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? "reveal.js/css/print/pdf.css" : "reveal.js/css/print/paper.css";
document.getElementsByTagName( 'head' )[0].appendChild( link );</script><link rel="stylesheet" href="css/custom.css"></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title" data-background-image="images/pexels-pixabay-159275.jpg"><h1>Jakże vspaniała maszyna</h1><p class="author"><small>Architektura OpenJDK dla upartych</small></p></section><section><section id="about_us"><h2>about us</h2></section><section id="krystian_zybała"><h2>Krystian Zybała</h2></section><section id="jarosław_pałka"><h2>Jarosław Pałka</h2><div class="slide-content"><div class="paragraph"><p>Neo4j (a graph database) performance engineer</p></div>
<div class="paragraph"><p>over 20 years with JVM,<br>
since early days of no native threads and,<br>
no JIT and slow as hell GC</p></div>
<div class="paragraph"><p>speaker, coder, architect</p></div>
<div class="paragraph"><p>founder of SegFault conference<br>
godfather of Programistyczna Grupa Rozwoju</p></div></div></section><section id="abstract"><h2>abstract</h2><div class="slide-content"><div class="ulist"><ul><li><p>JVM initialization</p></li><li><p>loading and verifying bytecode</p></li><li><p>bytecode interpreter</p></li><li><p>time for just-in-time compiler</p></li><li><p>garbage collector black magic</p></li></ul></div></div></section></section>
<section id="introduction_to_openjdk"><h2>Introduction to OpenJDK</h2></section>
<section id="if_you_want_to_follow_along"><h2>if you want to follow along</h2><div class="slide-content"><div class="literalblock"><div class="content"><pre>git clone https://github.com/openjdk/jdk17
cd jdk17
chmod +x configure
./configure // make sure your java points to JDK 17 or 16, this is required for boot JDK
make images
make vscode-project // import project workspace into VSCode</pre></div></div></div></section>
<section><section id="jvm_initialization"><h2>JVM initialization</h2></section><section id="oopmaps"><h2>OopMaps</h2></section><section id="safepoint"><h2>safepoint</h2></section><section id="stack_processing"><h2>stack processing</h2><div class="slide-content"><div class="paragraph"><p>During safepoint each thread stack is processing</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Always process three frames when starting an iteration.</p></div>
<div class="ulist"><div class="title">The three frames corresponds to:</div><ul><li><p>The callee frame</p></li><li><p>The caller frame</p></li><li><p>An extra frame to deal with unwinding safepointing on the way out. Sometimes, we also call into the runtime to on_unwind(), but then  hit a safepoint poll on the way out from the runtime.</p></li></ul></div>
<div class="paragraph"><p><code>This allows a callee to always be able to read state from its caller without needing any special barriers.</code></p></div></div></section><section id="jep_376"><h2>JEP-376</h2><div class="slide-content"><div class="paragraph"><p>Concurrent Thread-Stack Processing</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Remove thread-stack processing from ZGC safepoints.</p></div>
<div class="paragraph"><p>It also available in Shenandoah</p></div>
<div class="paragraph"><p>Each stack processes concurrently</p></div>
<div class="paragraph"><p>Only GC uses the OopMapCache during thread stack root scanning<br>
any other uses generate an oopmap but do not save it in the cache.</p></div></div></section><section id="make_stack_processing_lazy_cooperative_concurrent_and_incremental"><h2>Make stack processing lazy, cooperative, concurrent, and incremental.</h2></section><section id="remove_all_other_per_thread_root_processing_from_zgc_safepoints"><h2>Remove all other per-thread root processing from ZGC safepoints.</h2></section><section id="provide_a_mechanism_by_which_other_hotspot_subsystems_can_lazily_process_stacks"><h2>Provide a mechanism by which other HotSpot subsystems can lazily process stacks.</h2></section><section id="stack_watermark"><h2>Stack watermark</h2><div class="slide-content"><div class="paragraph"><p>All GC operations that scale with the size of the heap and the size of metaspace out of safepoint operations
and into concurrent phases.</p></div>
<div class="paragraph"><p><code>per-thread processing</code></p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>The only activities still done in GC safepoints are a subset of root processing and a time-bounded marking termination operation.</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Project Loom</p></div>
<div class="paragraph"><p>It necessary for Project Loom for lazy stack processing</p></div></div></section></section>
<section><section id="classloaders"><h2>classloaders</h2><div class="slide-content"><div class="paragraph"><p>bootstrap, runtime, application</p></div><div class="paragraph"><p><code>src/hotspot/share/runtime/init.cpp</code></p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">jint init_globals() {
  ...
  classLoader_init1();
  ...
}</code></pre></div></div></div></section><section id="universe_post_init"><h2>universe_post_init</h2><div class="slide-content"><div class="paragraph"><p><code>src/hotspot/share/memory/universe.cpp</code></p></div></div></section><section id="initialization"><h2>initialization</h2><div class="slide-content"><div class="paragraph"><p>Make sure klass is linked (verified) before initialization A class could already be verified, since it has been reflected upon.</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>VM treats linking as verification class.</p></div>
<div class="paragraph"><p>If class is already linked then it&#8217;s not necessary.</p></div>
<div class="paragraph"><p><code>src/hotspot/share/oops/instanceKlass.cpp</code></p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>All interfaces implemented by this class must linking before this class</p></div>
<div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">  Array&lt;InstanceKlass*&gt;* interfaces = local_interfaces();
  int num_interfaces = interfaces-&gt;length();
  for (int index = 0; index &lt; num_interfaces; index++) {
    InstanceKlass* interk = interfaces-&gt;at(index);
    interk-&gt;link_class_impl(CHECK_false);
  }</code></pre></div></div></div></section><section id="linking_with_verfication_together"><h2>Linking with verfication together</h2></section><section id="verfication_bytecode"><h2>Verfication bytecode</h2><div class="slide-content"><div class="paragraph"><p>src/hotspot/share/interpreter/abstractInterpreter.hpp</p></div></div></section><section id="check_constraints"><h2>Check constraints</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp"> SystemDictionaryShared::check_linking_constraints</code></pre></div></div></div></section><section id="vtable"><h2>vTable</h2><div class="slide-content"><div class="paragraph"><p>Initialize the vtable and interface table after methods have been rewritten since rewrite may fabricate new methods also does loader constraint checking</p></div></div></section><section id="stackmap"><h2>stackmap</h2><div class="slide-content"><div class="paragraph"><p>Uses to preverification of Java classes
Each stack_map_frame structure specifies the type state at a particular bytecode offset.</p></div></div></section></section>
<section id="bytecode_interpreter"><h2>bytecode interpreter</h2><div class="slide-content"><div class="ulist"><ul><li><p>bytecode interpreter and generator interpreter</p></li><li><p>method calls and entry points</p></li><li><p>exception handling</p></li><li><p>object allocation and cooperation with GC</p></li><li><p>stack &amp; local var table</p></li><li><p>physical and virtual frames</p></li><li><p>const method, method data and method counters</p></li></ul></div></div></section>
<section><section id="jvm_interpreter"><h2>JVM interpreter</h2><div class="slide-content"><div class="paragraph"><p>this isn&#8217;t actual all that simple, because we have two different interpreters</p></div><div class="ulist"><ul><li><p>high level language version (aka c++ interpreter), actual interpretation of bytecodes,</p></li><li><p>assembly language version (aka template interpreter), generation of assembly code that creates and manages interpreter runtime frames</p></li></ul></div></div></section><section><div class="slide-content"><div class="paragraph"><p>src/hotspot/share/interpreter/abstractInterpreter.hpp</p></div>
<div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">// This file contains the platform-independent parts
// of the abstract interpreter and the abstract interpreter generator.

// Organization of the interpreter(s). There exists two different interpreters in hotpot
// an assembly language version (aka template interpreter) and a high level language version
// (aka c++ interpreter). Th division of labor is as follows:

// Template Interpreter          Zero Interpreter       Functionality
//
// templateTable*                bytecodeInterpreter*   actual interpretation of bytecodes
//
// templateInterpreter*          zeroInterpreter*       generation of assembly code that creates
//                                                      and manages interpreter runtime frames.
//</code></pre></div></div></div></section><section id="a_word_about_zero_jvm"><h2>a word about "zero" JVM</h2><div class="slide-content"><div class="paragraph"><p>a "zero" JVM is a version of JVM which with minimal (in a perfect world "zero") set of changes will run on new architecture and operating system</p></div>
<div class="paragraph"><p>it means as long GCC (in general C compiler) works on this architecture, JVM
will work there (of course only in interpreted mode)</p></div>
<div class="paragraph"><p>it doesn&#8217;t mean Java will work there, only JVM (mindfuck)</p></div></div></section><section id="bytecodeinterpreter"><h2>BytecodeInterpreter</h2><div class="slide-content"><div class="paragraph"><p>for simplicity sake, we are going to take a look at C++ interpreter<br>
which you can find in<br>
<code>src/hotspot/share/interpreter/zero/bytecodeInterpreter.hpp</code><br>
<code>src/hotspot/share/interpreter/zero/zeroInterpreter.hpp</code><br>
<code>src/hotspot/share/interpreter/zero/zeroInterpreterGenerator.hpp</code></p></div></div></section><section><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">// src/hotspot/share/memory/allocation.hpp
// Base class for objects allocated on the stack only.
// Calling new or delete will result in fatal error.
class StackObj ALLOCATION_SUPER_CLASS_SPEC {
    ...
};

// src/hotspot/share/interpreter/zero/bytecodeInterpreter.hpp
class BytecodeInterpreter : StackObj {
    ...
};

typedef class BytecodeInterpreter* interpreterState;

static void run(interpreterState istate);</code></pre></div></div></div></section><section id="static_void_runinterpreterstate_istate" data-background-image="https://media.giphy.com/media/JUwT5qRmpFjqOhCLAB/giphy.gif"><h2>static void run(interpreterState istate);</h2></section><section><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">  intptr_t*        topOfStack = (intptr_t *)istate-&gt;stack(); /* access with STACK macros */
  address          pc = istate-&gt;bcp();
  jubyte opcode;
  intptr_t*        locals = istate-&gt;locals();
  ConstantPoolCache*    cp = istate-&gt;constants(); // method()-&gt;constants()-&gt;cache()
#ifdef LOTS_OF_REGS
  JavaThread*      THREAD = istate-&gt;thread();
#else</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>interpreter uses messages to communicate with itself :)<br>
and with frame manager (aka interpreter generator)</p></div>
<div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">    enum messages {
         no_request = 0,            // unused
         initialize,                // Perform one time interpreter initializations (assumes all switches set)
         // status message to C++ interpreter
         method_entry,              // initial method entry to interpreter
         method_resume,             // frame manager response to return_from_method request (assuming a frame to resume)
         deopt_resume,              // returning from a native call into a deopted frame
         deopt_resume2,             // deopt resume as a result of a PopFrame
         got_monitors,              // frame manager response to more_monitors request
         rethrow_exception,         // unwinding and throwing exception
         // requests to frame manager from C++ interpreter
         call_method,               // request for new frame from interpreter, manager responds with method_entry
         return_from_method,        // request from interpreter to unwind, manager responds with method_continue
         more_monitors,             // need a new monitor
         throwing_exception,        // unwind stack and rethrow
         popping_frame,             // unwind call and retry call
         do_osr,                    // request this invocation be OSR's
         early_return               // early return as commanded by jvmti
    };</code></pre></div></div></div></section><section><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-none hljs" data-noescape="true">initialize:
    entry_method:
        if(synchronized)
            lock;
        goto run;

run:
    do_update_instruction_count;
    fetch opcode;
    (use_labels || opcode_switch)</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>we could go through all opcodes, but there are only few cases that are interesting</p></div></div></section><section><div class="slide-content"><div class="imageblock"><img src="images/diag-881d8feb395c9a96277466fbe9300ebc.png" alt="Diagram"></div></div></section><section><div class="slide-content"><div class="imageblock"><img src="images/diag-881d8feb395c9a96277466fbe9300ebc.png" alt="Diagram"></div></div></section><section id="a_twisted_logic_of_calling_method"><h2>a twisted logic of calling method</h2><div class="slide-content"><div class="imageblock"><img src="images/diag-6314817a5dc3ad8a4e996a888d0ecbb8.png" alt="Diagram"></div></div></section><section id="method_and_call_entry_point"><h2>method and call entry point</h2><div class="slide-content"><div class="paragraph"><p>a method in JVM can be either interpreted or compiled<br>
(to complete a picture it can also be native or intrinsic)</p></div>
<div class="paragraph"><p>from an interpreted method you can call either<br>
other interpreted or compiled method<br>
but how do you know if method has been compiled?<br>
and how do you handle different logic to call interpreted vs compiled?</p></div></div></section><section><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">// src/hotspot/share/oops/method.hpp:Method

// Entry point for calling both from and to the interpreter.
  address _i2i_entry;           // All-args-on-stack calling convention
  // Entry point for calling from compiled code, to compiled code if it exists
  // or else the interpreter.
  volatile address _from_compiled_entry;        // Cache of: _code ? _code-&gt;entry_point() : _adapter-&gt;c2i_entry()
  // The entry point for calling both from and to compiled code is
  // "_code-&gt;entry_point()".  Because of tiered compilation and de-opt, this
  // field can come and go.  It can transition from NULL to not-null at any
  // time (whenever a compile completes).  It can transition from not-null to
  // NULL only at safepoints (because of a de-opt).
  CompiledMethod* volatile _code;                       // Points to the corresponding piece of native code
  volatile address           _from_interpreted_entry; // Cache of _code ? _adapter-&gt;i2c_entry() : _i2i_entry</code></pre></div></div></div></section><section id="frames"><h2>frames</h2></section><section></section><section><div class="slide-content"><div class="paragraph"><p>we have two kinds of frames, physical frames (aka frames) and virtual frames (aka vframes)</p></div>
<div class="paragraph"><p>physical frames can be either C (native) or Java frame, where Java frame can be either interpreted or compiled</p></div>
<div class="paragraph"><p>virtual frame represent source-level frames, which means if methods is inlined,
there will be single physical frame and many virtual frames</p></div></div></section><section id="method_data_method_counters"><h2>method data &amp; method counters</h2></section><section id="on_stack_replacement"><h2>on-stack replacement</h2></section></section>
<section><section id="time_for_just_in_time_compiler"><h2>time for just-in-time compiler</h2><div class="slide-content"><div class="ulist"><ul><li><p>C1/C2 (PGO)</p></li><li><p>method counters &amp; type profile (co jest profilowane)</p></li><li><p>to jest plugin</p></li><li><p>CompilationTask &#8594; CompilationQueue (bail out)</p></li><li><p>simplePolicy.hpp</p></li><li><p>speculating compiler &#8594; deopt</p></li><li><p>uncommontrap &#8594; stab</p></li><li><p>CHA</p></li><li><p>OSR &#8594; jak to podmiana działa ( napisz benchmar z while true)</p></li><li><p>register allocation &amp; inline</p></li></ul></div></div></section><section id="a_few_words_about_jit"><h2>a few words about JIT</h2><div class="slide-content"><div class="paragraph"><p>JIT (just-in-time compiler) in JVM was a major step in the world of JITs</p></div>
<div class="ulist"><ul><li><p>profile guided optimizations</p></li><li><p>speculating compilation (with traps and deoptimizations)</p></li><li><p>actually two not one compiler</p></li><li><p>on-stack replacement</p></li><li><p>used SSA (single static assigment) form (using "sea of nodes" developed by Cliff Click)</p></li></ul></div></div></section><section><div class="slide-content"><div class="paragraph"><p>we are not going to dive into implemented optimizations,<br>
register allocations,<br>
escape analisys,<br>
inlining</p></div>
<div class="paragraph"><p>will focus on JIT infrastructure code</p></div></div></section><section id="need_for_speed" class="highlight_section_title" data-background-image="https://media.giphy.com/media/xTiTnFM0Cr2xcGUsVy/giphy.gif"><h2>need for speed</h2></section><section><div class="slide-content"><div class="paragraph"><p>so, who decides when code gets compiled?<br>
(and deoptimized)</p></div>
<div class="paragraph"><p><code>src/hotspot/share/compiler/compilationPolicy.hpp</code></p></div>
<div class="paragraph"><p>let&#8217;s disassemble the first parts</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>The system supports 5 execution levels:</p></div>
<div class="ulist"><ul><li><p>level 0 - interpreter</p></li><li><p>level 1 - C1 with full optimization (no profiling)</p></li><li><p>level 2 - C1 with invocation and backedge counters</p></li><li><p>level 3 - C1 with full profiling (level 2 + MDO)</p></li><li><p>level 4 - C2</p></li></ul></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Levels 0, 2 and 3 periodically notify the runtime about the current value of the counters (invocation counters and backedge counters). The frequency of these notifications is different at each level. These notifications are used by the policy to decide what transition to make.</p></div></div></section><section id="backedge_counters"><h2>backedge counters</h2><div class="slide-content"><div class="paragraph"><p>invocation counter are pretty obvious</p></div>
<div class="paragraph"><p>what the hell is backedge counter?</p></div>
<div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">for(;;){

} // increment backedge counter</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Execution starts at level 0 (interpreter), then the policy can decide either to compile the method at level 3 or level 2. The decision is based on the following factors:</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>The length of the C2 queue determines the next level. The observation is that level 2 is generally faster than level 3 by about 30%, therefore we would want to minimize the time a method spends at level 3. We should only spend the time at level 3 that is necessary to get adequate profiling. So, if the C2 queue is long enough it is more beneficial to go first to level 2, because if we transitioned to level 3 we would be stuck there until our C2 compile request makes its way through the long queue. When the load on C2 recedes we are going to recompile at level 3 and start gathering profiling information.</p></div></div></section><section id="queue_not_again"><h2>queue? not again</h2><div class="slide-content"><div class="paragraph"><p>there are few components shared by both compilers,<br>
<code>src/hotspot/share/compiler/compileBroker.hpp</code>:</p></div>
<div class="ulist"><ul><li><p>CompileQueue</p></li><li><p>CompileTask</p></li><li><p>CompileBroker</p></li></ul></div></div></section><section><div class="slide-content"><div class="paragraph"><p>when compilation policy decides that method should be compiled, it puts a method (a compile task) onto one of the queues</p></div>
<div class="paragraph"><p>by default C1 queue has one worker threads and C2 has two (it all depends on your machine)</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>The length of C1 queue is used to dynamically adjust the thresholds, so as to introduce additional filtering if the compiler is overloaded. The rationale is that by the time a method gets compiled it can become unused, so it doesn&#8217;t make sense to put too much onto the queue.</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>After profiling is completed at level 3 the transition is made to level 4. Again, the length of the C2 queue is used as a feedback to adjust the thresholds.
After the first C1 compile some basic information is determined about the code like the number of the blocks and the number of the loops. Based on that it can be decided that a method is trivial and compiling it with C1 will yield the same code. In this case the method is compiled at level 1 instead of 4.</p></div></div></section><section id="blocks"><h2>blocks?</h2><div class="slide-content"><div class="paragraph"><p>back to school</p></div>
<div class="paragraph"><p>one form of representation of program is CFG (control flow graph)</p></div></div></section><section><div class="slide-content"><div class="quoteblock"><blockquote>    In a control-flow graph each node in the graph represents a basic block, i.e. a straight-line piece of code without any jumps or jump targets; jump targets start a block, and jumps end a block. Directed edges are used to represent jumps in the control flow. There are, in most presentations, two specially designated blocks: the entry block, through which control enters into the flow graph, and the exit block, through which all control flow leaves</blockquote><div class="attribution"><cite>Wikipedia</cite></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Command line options:
- <code>Tier?InvokeNotifyFreqLog</code> and <code>Tier?BackedgeNotifyFreqLog</code> control the frequency of method invocation and backedge notifications. Basically every n-th invocation or backedge a mutator thread makes a call into the runtime.</p></div>
<div class="ulist"><ul><li><p><code>Tier?InvocationThreshold</code>, <code>Tier?CompileThreshold</code>, <code>Tier?BackEdgeThreshold</code>, <code>Tier?MinInvocationThreshold</code> control compilation thresholds.
Level 2 thresholds are not used and are provided for option-compatibility and potential future use.</p></li></ul></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Other thresholds work as follows:
Transition from interpreter (level 0) to C1 with full profiling (level 3) happens when the following predicate is true (X is the level):</p></div>
<div class="literalblock"><div class="content"><pre>i &gt; TierXInvocationThreshold * s || (i &gt; TierXMinInvocationThreshold * s  &amp;&amp; i + b &gt; TierXCompileThreshold * s),</pre></div></div>
<div class="paragraph"><p>where $i$ is the number of method invocations, $b$ number of backedges and $s$ is the scaling coefficient that will be discussed further.</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>The intuition is to equalize the time that is spend profiling each method.
The same predicate is used to control the transition from level 3 to level 4 (C2). It should be noted though that the thresholds are relative. Moreover i and b for the 0&#8594;3 transition come from Method* and for 3&#8594;4 transition they come from MDO (since profiled invocations are counted separately). Finally, if a method does not contain anything worth profiling, a transition from level 3 to level 4 occurs without considering thresholds (e.g., with fewer invocations than what is specified by Tier4InvocationThreshold).</p></div></div></section><section id="method_and_mdo"><h2>Method* and MDO</h2><div class="slide-content"><div class="paragraph"><p><code>Method</code> is a JVM class which models bytecode method</p></div>
<div class="paragraph"><p><code>src/hotspot/share/oops/method.hpp</code></p></div>
<div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">class Method : public Metadata {
 friend class VMStructs;
 friend class JVMCIVMStructs;
 private:
  // If you add a new field that points to any metaspace object, you
  // must add this field to Method::metaspace_pointers_do().
  ConstMethod*      _constMethod;                // Method read-only data.
  MethodData*       _method_data;
  MethodCounters*   _method_counters;
}</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>MDO are instances of <code>MethodData</code>,<br>
which are only use at compilation level 3,<br>
so they are not always available<br>
(your intuition is right C2 methods don&#8217;t have profilers)</p></div></div></section><section><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">class MethodCounters : public Metadata {
 friend class VMStructs;
 friend class JVMCIVMStructs;
 private:
  InvocationCounter _invocation_counter;         // Incremented before each activation of the method - used to trigger frequency-based optimizations
  InvocationCounter _backedge_counter;           // Incremented before each backedge taken - used to trigger frequency-based optimizations
  jlong             _prev_time;                   // Previous time the rate was acquired
  float             _rate;                        // Events (invocation and backedge counter increments) per millisecond
  int               _nmethod_age;
  int               _invoke_mask;                 // per-method Tier0InvokeNotifyFreqLog
  int               _backedge_mask;               // per-method Tier0BackedgeNotifyFreqLog
  int               _prev_event_count;            // Total number of events saved at previous callback
#if COMPILER2_OR_JVMCI
  u2                _interpreter_throwout_count; // Count of times method was exited via exception while interpreting
#endif
#if INCLUDE_JVMTI
  u2                _number_of_breakpoints;      // fullspeed debugging support
#endif
  // NMethod age is a counter for warm methods detection in the code cache sweeper.
  // The counter is reset by the sweeper and is decremented by some of the compiled
  // code. The counter values are interpreted as follows:
  // 1. (HotMethodDetection..INT_MAX] - initial value, no counters inserted
  // 2. [1..HotMethodDetectionLimit)  - the method is warm, the counter is used
  //                                    to figure out which methods can be flushed.
  // 3. (INT_MIN..0]                  - method is hot and will deopt and get
  //                                    recompiled without the counters
  u1                _highest_comp_level;          // Highest compile level this method has ever seen.
  u1                _highest_osr_comp_level;      // Same for OSR level</code></pre></div></div></div></section><section id="methoddata"><h2>MethodData</h2><div class="slide-content"><div class="paragraph"><p><code>MethodCounter</code> has really basic profiling information (only counters),<br>
the magic is in <code>MethodData</code></p></div>
<div class="paragraph"><p><code>src/hotspot/share/oops/methodData.hpp</code></p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>The MethodData object collects counts and other profile information
during zeroth-tier (interpretive) and first-tier execution.
The profile is used later by compilation heuristics.  Some heuristics
enable use of aggressive (or "heroic") optimizations.  An aggressive
optimization often has a down-side, a corner case that it handles
poorly, but which is thought to be rare.  The profile provides
evidence of this rarity for a given method or even BCI.  It allows
the compiler to back out of the optimization at places where it
has historically been a poor choice.  Other heuristics try to use
specific information gathered about types observed at a given site.</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>All data in the profile is approximate.  It is expected to be accurate
on the whole, but the system expects occasional inaccuraces, due to
counter overflow, multiprocessor races during data collection, space
limitations, missing MDO blocks, etc.  Bad or missing data will degrade
optimization quality but will not affect correctness.  Also, each MDO
is marked with its birth-date ("creation_mileage") which can be used
to assess the quality ("maturity") of its data.</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Short (&lt;32-bit) counters are designed to overflow to a known "saturated"
state.  Also, certain recorded per-BCI events are given one-bit counters
which overflow to a saturated state which applied to all counters at
that BCI.  In other words, there is a small lattice which approximates
the ideal of an infinite-precision counter for each event at each BCI,
and the lattice quickly "bottoms out" in a state where all counters
are taken to be indefinitely large.</p></div>
<div class="literalblock"><div class="content"><pre> The reader will find many data races in profile gathering code, starting
 with invocation counter incrementation.  None of these races harm correct
 execution of the compiled code.
== heap</pre></div></div>
<div class="paragraph"><p>Heap is initilized during creating the Universe.</p></div></div></section><section id="gc" data-background-image="https://media4.giphy.com/media/njZPp4pQ0g4fe/giphy.gif"><h2>GC</h2><div class="slide-content"><div class="paragraph"><p>Algorithm is choose during creating the Universe</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>But sometimes is different than we expect</p></div>
<div class="paragraph"><p>Ergo, ergo, ergo..</p></div></div></section><section id="roots"><h2>roots</h2><div class="slide-content"><div class="paragraph"><p>Root is basic concept in GC cycle</p></div>
<div class="paragraph"><p>Root is thread, local variables, static fields, final fields.</p></div></div></section><section id="vm_threads_are_roots"><h2>VM threads are roots</h2></section><section id="bariers" data-background-image="https://media2.giphy.com/media/wLJSjc5fzMJtS/giphy.gif"><h2>bariers</h2><div class="slide-content"><div class="paragraph"><p>Barriers need JIT help for speed</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>G1, Shendandoah, ZGC</p></div>
<div class="paragraph"><p>Only these GCs use barriers</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Barriers</p></div>
<div class="paragraph"><p>Barrier is simple assmebly code injected in particular place
G1 uses load/store (aka read/write) barriers
Shenandoah and ZGC uses load barrier</p></div>
<div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-assembly hljs" data-noescape="true" data-lang="assembly">0x00007fabf9777f48:   mov    -0x28(%rbp),%rbx
0x00007fabf9777f4c:   test   %rbx,%rbx
0x00007fabf9777f4f:   je     0x00007fabf9777fdc</code></pre></div></div></div></section><section id="card_table"><h2>card table</h2><div class="slide-content"><div class="paragraph"><p>After creating heap starting process to collecting heap.
Card table needs additional memory space, if doesn&#8217;t VM exit</p></div></div></section><section data-background-image="https://media2.giphy.com/media/kf4SXNzSfiAiQ/giphy.gif"><div class="slide-content"><div class="paragraph"><p>TLAB</p></div>
<div class="paragraph"><p>Thread Local Allocation Buffer</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Each thread has own space to allocate</p></div>
<div class="paragraph"><p>If object is too big then allocation is outside of TLAB</p></div>
<div class="listingblock"><div class="content"><pre>// Load the current thread-local allocation pointer
mov     0x118(%r15),%rax

// Compute new thread-local allocation pointer by adding allocation size (16 bytes)
mov     %rax,%r10
add     $0x10,%r10</pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Outside TLAB allocation (aka global allocation)</p></div>
<div class="paragraph"><p>We need take slow path it means</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>TLAB Size</p></div>
<div class="paragraph"><p>During starting the Universe then TLAB size is calculated</p></div>
<div class="paragraph"><p>src/hotspot/share/gc/shared/threadLocalAllocBuffer.cpp</p></div>
<div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-cpp hljs" data-noescape="true" data-lang="cpp">size_t ThreadLocalAllocBuffer::initial_desired_size() {
  size_t init_sz = 0;

  if (TLABSize &gt; 0) {
    init_sz = TLABSize / HeapWordSize;
  } else {

    unsigned int nof_threads = ThreadLocalAllocStats::allocating_threads_avg();

    init_sz  = (Universe::heap()-&gt;tlab_capacity(thread()) / HeapWordSize) /
                      (nof_threads * target_refills());
    init_sz = align_object_size(init_sz);
  }
  init_sz = MIN2(MAX2(init_sz, min_size()), max_size());
  return init_sz;
}</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>TLAB Size recalculting</p></div>
<div class="paragraph"><p>Every FullGC TLAB is resizing if needed</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Take off TLAB</p></div>
<div class="paragraph"><p>It not good idea</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>JIT</p></div>
<div class="paragraph"><p>If C2 is enabled extra space is needed otherwise prefetching instructions generated by the C2
compiler will fault</p></div>
<div class="paragraph"><p><code>src/hotspot/share/gc/g1/c1</code><br>
<code>src/hotspot/share/gc/g1/c2</code><br></p></div>
<div class="paragraph"><p><code>src/hotspot/share/gc/shenandoah/c1</code><br>
<code>src/hotspot/share/gc/shenandoah/c2</code><br></p></div>
<div class="paragraph"><p><code>src/hotspot/share/gc/z/c1</code><br>
<code>src/hotspot/share/gc/z/c2</code><br></p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Retrie TLAB</p></div>
<div class="paragraph"><p>GC can retire TLAB space but only
ZGC and Shenandoah retries space during concurrent stack processing</p></div></div></section></section></div></div><script src="reveal.js/js/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
});

// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  // Display presentation control arrows
  controls: false,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: false,
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Add the current slide number to the URL hash so that reloading the
  // page/copying the URL will return you to the same slide
  hash: false,
  // Push each slide change to the browser history. Implies `hash: true`
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Disables the default reveal.js slide layout so that you can use custom CSS layout
  disableLayout: false,
  // Vertical centering of slides
  center: true,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // See https://github.com/hakimel/reveal.js/#navigation-mode
  navigationMode: 'default',
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Global override for preloading lazy-loaded iframes
  // - null: Iframes with data-src AND data-preload will be loaded when within
  //   the viewDistance, iframes with only data-src will be loaded when visible
  // - true: All iframes with data-src will be loaded when within the viewDistance
  // - false: All iframes with data-src will be loaded only when visible
  preloadIframes: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Specify the total time in seconds that is available to
  // present.  If this is set to a nonzero value, the pacing
  // timer will work out the time available for each slide,
  // instead of using the defaultTiming value
  totalTime: 0,
  // Specify the minimum amount of time you want to allot to
  // each slide, if using the totalTime calculation method.  If
  // the automated time allocation causes slide pacing to fall
  // below this threshold, then you will see an alert in the
  // speaker notes window
  minimumTimePerSlide: 0,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hide cursor if inactive
  hideInactiveCursor: true,
  // Time before the cursor is hidden (in ms)
  hideCursorTime: 5000,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'slide',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Number of slides away from the current that are visible on mobile
  // devices. It is advisable to set this to a lower number than
  // viewDistance in order to save resources.
  mobileViewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 1920,
  height: 1080,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // PDF Export Options
  // Put each fragment on a separate page
  pdfSeparateFragments: true,
  // For slides that do not fit on a page, max number of pages
  pdfMaxPagesPerSlide: 1,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
      { src: 'reveal.js/plugin/notes/notes.js', async: true }
  ],

  

});</script><script>var dom = {};
dom.slides = document.querySelector('.reveal .slides');

function getRemainingHeight(element, slideElement, height) {
  height = height || 0;
  if (element) {
    var newHeight, oldHeight = element.style.height;
    // Change the .stretch element height to 0 in order find the height of all
    // the other elements
    element.style.height = '0px';
    // In Overview mode, the parent (.slide) height is set of 700px.
    // Restore it temporarily to its natural height.
    slideElement.style.height = 'auto';
    newHeight = height - slideElement.offsetHeight;
    // Restore the old height, just in case
    element.style.height = oldHeight + 'px';
    // Clear the parent (.slide) height. .removeProperty works in IE9+
    slideElement.style.removeProperty('height');
    return newHeight;
  }
  return height;
}

function layoutSlideContents(width, height) {
  // Handle sizing of elements with the 'stretch' class
  toArray(dom.slides.querySelectorAll('section .stretch')).forEach(function (element) {
    // Determine how much vertical space we can use
    var limit = 5; // hard limit
    var parent = element.parentNode;
    while (parent.nodeName !== 'SECTION' && limit > 0) {
      parent = parent.parentNode;
      limit--;
    }
    if (limit === 0) {
      // unable to find parent, aborting!
      return;
    }
    var remainingHeight = getRemainingHeight(element, parent, height);
    // Consider the aspect ratio of media elements
    if (/(img|video)/gi.test(element.nodeName)) {
      var nw = element.naturalWidth || element.videoWidth, nh = element.naturalHeight || element.videoHeight;
      var es = Math.min(width / nw, remainingHeight / nh);
      element.style.width = (nw * es) + 'px';
      element.style.height = (nh * es) + 'px';
    } else {
      element.style.width = width + 'px';
      element.style.height = remainingHeight + 'px';
    }
  });
}

function toArray(o) {
  return Array.prototype.slice.call(o);
}

Reveal.addEventListener('slidechanged', function () {
  layoutSlideContents(1920, 1080)
});
Reveal.addEventListener('ready', function () {
  layoutSlideContents(1920, 1080)
});
Reveal.addEventListener('resize', function () {
  layoutSlideContents(1920, 1080)
});</script><link rel="stylesheet" href="reveal.js/lib/css/monokai.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>

<script>

/* highlightjs-line-numbers.js 2.6.0 | (C) 2018 Yauheni Pakala | MIT License | github.com/wcoder/highlightjs-line-numbers.js */
/* Edited by Hakim for reveal.js; removed async timeout */
!function(n,e){"use strict";function t(){var n=e.createElement("style");n.type="text/css",n.innerHTML=g(".{0}{border-collapse:collapse}.{0} td{padding:0}.{1}:before{content:attr({2})}",[v,L,b]),e.getElementsByTagName("head")[0].appendChild(n)}function r(t){"interactive"===e.readyState||"complete"===e.readyState?i(t):n.addEventListener("DOMContentLoaded",function(){i(t)})}function i(t){try{var r=e.querySelectorAll("code.hljs,code.nohighlight");for(var i in r)r.hasOwnProperty(i)&&l(r[i],t)}catch(o){n.console.error("LineNumbers error: ",o)}}function l(n,e){"object"==typeof n&&f(function(){n.innerHTML=s(n,e)})}function o(n,e){if("string"==typeof n){var t=document.createElement("code");return t.innerHTML=n,s(t,e)}}function s(n,e){e=e||{singleLine:!1};var t=e.singleLine?0:1;return c(n),a(n.innerHTML,t)}function a(n,e){var t=u(n);if(""===t[t.length-1].trim()&&t.pop(),t.length>e){for(var r="",i=0,l=t.length;i<l;i++)r+=g('<tr><td class="{0}"><div class="{1} {2}" {3}="{5}"></div></td><td class="{4}"><div class="{1}">{6}</div></td></tr>',[j,m,L,b,p,i+1,t[i].length>0?t[i]:" "]);return g('<table class="{0}">{1}</table>',[v,r])}return n}function c(n){var e=n.childNodes;for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];h(r.textContent)>0&&(r.childNodes.length>0?c(r):d(r.parentNode))}}function d(n){var e=n.className;if(/hljs-/.test(e)){for(var t=u(n.innerHTML),r=0,i="";r<t.length;r++){var l=t[r].length>0?t[r]:" ";i+=g('<span class="{0}">{1}</span>\n',[e,l])}n.innerHTML=i.trim()}}function u(n){return 0===n.length?[]:n.split(y)}function h(n){return(n.trim().match(y)||[]).length}function f(e){e()}function g(n,e){return n.replace(/{(\d+)}/g,function(n,t){return e[t]?e[t]:n})}var v="hljs-ln",m="hljs-ln-line",p="hljs-ln-code",j="hljs-ln-numbers",L="hljs-ln-n",b="data-line-number",y=/\r\n|\r|\n/g;n.hljs?(n.hljs.initLineNumbersOnLoad=r,n.hljs.lineNumbersBlock=l,n.hljs.lineNumbersValue=o,t()):n.console.error("highlight.js not detected!")}(window,document);

/**
 * This reveal.js plugin is wrapper around the highlight.js
 * syntax highlighting library.
 */
(function( root, factory ) {
  if (typeof define === 'function' && define.amd) {
    root.RevealHighlight = factory();
  } else if( typeof exports === 'object' ) {
    module.exports = factory();
  } else {
    // Browser globals (root is window)
    root.RevealHighlight = factory();
  }
}( this, function() {

  // Function to perform a better "data-trim" on code snippets
  // Will slice an indentation amount on each line of the snippet (amount based on the line having the lowest indentation length)
  function betterTrim(snippetEl) {
    // Helper functions
    function trimLeft(val) {
      // Adapted from https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/Trim#Polyfill
      return val.replace(/^[\s\uFEFF\xA0]+/g, '');
    }
    function trimLineBreaks(input) {
      var lines = input.split('\n');

      // Trim line-breaks from the beginning
      for (var i = 0; i < lines.length; i++) {
        if (lines[i].trim() === '') {
          lines.splice(i--, 1);
        } else break;
      }

      // Trim line-breaks from the end
      for (var i = lines.length-1; i >= 0; i--) {
        if (lines[i].trim() === '') {
          lines.splice(i, 1);
        } else break;
      }

      return lines.join('\n');
    }

    // Main function for betterTrim()
    return (function(snippetEl) {
      var content = trimLineBreaks(snippetEl.innerHTML);
      var lines = content.split('\n');
      // Calculate the minimum amount to remove on each line start of the snippet (can be 0)
      var pad = lines.reduce(function(acc, line) {
        if (line.length > 0 && trimLeft(line).length > 0 && acc > line.length - trimLeft(line).length) {
          return line.length - trimLeft(line).length;
        }
        return acc;
      }, Number.POSITIVE_INFINITY);
      // Slice each line with this amount
      return lines.map(function(line, index) {
        return line.slice(pad);
      })
        .join('\n');
    })(snippetEl);
  }

  var RevealHighlight = {

    HIGHLIGHT_STEP_DELIMITER: '|',
    HIGHLIGHT_LINE_DELIMITER: ',',
    HIGHLIGHT_LINE_RANGE_DELIMITER: '-',

    init: function() {

      // Read the plugin config options and provide fallbacks
      var config = Reveal.getConfig().highlight || {};
      config.highlightOnLoad = typeof config.highlightOnLoad === 'boolean' ? config.highlightOnLoad : true;
      config.escapeHTML = typeof config.escapeHTML === 'boolean' ? config.escapeHTML : true;

      [].slice.call( document.querySelectorAll( '.reveal pre code' ) ).forEach( function( block ) {

        // Trim whitespace if the "data-trim" attribute is present
        if( block.hasAttribute( 'data-trim' ) && typeof block.innerHTML.trim === 'function' ) {
          block.innerHTML = betterTrim( block );
        }

        // Escape HTML tags unless the "data-noescape" attrbute is present
        if( config.escapeHTML && !block.hasAttribute( 'data-noescape' )) {
          block.innerHTML = block.innerHTML.replace( /</g,"&lt;").replace(/>/g, '&gt;' );
        }

        // Re-highlight when focus is lost (for contenteditable code)
        block.addEventListener( 'focusout', function( event ) {
          hljs.highlightBlock( event.currentTarget );
        }, false );

        if( config.highlightOnLoad ) {
          RevealHighlight.highlightBlock( block );
        }
      } );

    },

    /**
     * Highlights a code block. If the <code> node has the
     * 'data-line-numbers' attribute we also generate slide
     * numbers.
     *
     * If the block contains multiple line highlight steps,
     * we clone the block and create a fragment for each step.
     */
    highlightBlock: function( block ) {

      hljs.highlightBlock( block );

      // Don't generate line numbers for empty code blocks
      if( block.innerHTML.trim().length === 0 ) return;

      if( block.hasAttribute( 'data-line-numbers' ) ) {
        hljs.lineNumbersBlock( block, { singleLine: true } );

        // If there is at least one highlight step, generate
        // fragments
        var highlightSteps = RevealHighlight.deserializeHighlightSteps( block.getAttribute( 'data-line-numbers' ) );
        if( highlightSteps.length > 1 ) {

          // If the original code block has a fragment-index,
          // each clone should follow in an incremental sequence
          var fragmentIndex = parseInt( block.getAttribute( 'data-fragment-index' ), 10 );
          if( typeof fragmentIndex !== 'number' || isNaN( fragmentIndex ) ) {
            fragmentIndex = null;
          }

          // Generate fragments for all steps except the original block
          highlightSteps.slice(1).forEach( function( highlight ) {

            var fragmentBlock = block.cloneNode( true );
            fragmentBlock.setAttribute( 'data-line-numbers', RevealHighlight.serializeHighlightSteps( [ highlight ] ) );
            fragmentBlock.classList.add( 'fragment' );
            block.parentNode.appendChild( fragmentBlock );
            RevealHighlight.highlightLines( fragmentBlock );

            if( typeof fragmentIndex === 'number' ) {
              fragmentBlock.setAttribute( 'data-fragment-index', fragmentIndex );
              fragmentIndex += 1;
            }
            else {
              fragmentBlock.removeAttribute( 'data-fragment-index' );
            }

          } );

          block.removeAttribute( 'data-fragment-index' )
          block.setAttribute( 'data-line-numbers', RevealHighlight.serializeHighlightSteps( [ highlightSteps[0] ] ) );

        }

        RevealHighlight.highlightLines( block );

      }

    },

    /**
     * Visually emphasize specific lines within a code block.
     * This only works on blocks with line numbering turned on.
     *
     * @param {HTMLElement} block a <code> block
     * @param {String} [linesToHighlight] The lines that should be
     * highlighted in this format:
     * "1" 		= highlights line 1
     * "2,5"	= highlights lines 2 & 5
     * "2,5-7"	= highlights lines 2, 5, 6 & 7
     */
    highlightLines: function( block, linesToHighlight ) {

      var highlightSteps = RevealHighlight.deserializeHighlightSteps( linesToHighlight || block.getAttribute( 'data-line-numbers' ) );

      if( highlightSteps.length ) {

        highlightSteps[0].forEach( function( highlight ) {

          var elementsToHighlight = [];

          // Highlight a range
          if( typeof highlight.end === 'number' ) {
            elementsToHighlight = [].slice.call( block.querySelectorAll( 'table tr:nth-child(n+'+highlight.start+'):nth-child(-n+'+highlight.end+')' ) );
          }
          // Highlight a single line
          else if( typeof highlight.start === 'number' ) {
            elementsToHighlight = [].slice.call( block.querySelectorAll( 'table tr:nth-child('+highlight.start+')' ) );
          }

          if( elementsToHighlight.length ) {
            elementsToHighlight.forEach( function( lineElement ) {
              lineElement.classList.add( 'highlight-line' );
            } );

            block.classList.add( 'has-highlights' );
          }

        } );

      }

    },

    /**
     * Parses and formats a user-defined string of line
     * numbers to highlight.
     *
     * @example
     * RevealHighlight.deserializeHighlightSteps( '1,2|3,5-10' )
     * // [
     * //   [ { start: 1 }, { start: 2 } ],
     * //   [ { start: 3 }, { start: 5, end: 10 } ]
     * // ]
     */
    deserializeHighlightSteps: function( highlightSteps ) {

      // Remove whitespace
      highlightSteps = highlightSteps.replace( /\s/g, '' );

      // Divide up our line number groups
      highlightSteps = highlightSteps.split( RevealHighlight.HIGHLIGHT_STEP_DELIMITER );

      return highlightSteps.map( function( highlights ) {

        return highlights.split( RevealHighlight.HIGHLIGHT_LINE_DELIMITER ).map( function( highlight ) {

          // Parse valid line numbers
          if( /^[\d-]+$/.test( highlight ) ) {

            highlight = highlight.split( RevealHighlight.HIGHLIGHT_LINE_RANGE_DELIMITER );

            var lineStart = parseInt( highlight[0], 10 ),
              lineEnd = parseInt( highlight[1], 10 );

            if( isNaN( lineEnd ) ) {
              return {
                start: lineStart
              };
            }
            else {
              return {
                start: lineStart,
                end: lineEnd
              };
            }

          }
          // If no line numbers are provided, no code will be highlighted
          else {

            return {};

          }

        } );

      } );

    },

    /**
     * Serializes parsed line number data into a string so
     * that we can store it in the DOM.
     */
    serializeHighlightSteps: function( highlightSteps ) {

      return highlightSteps.map( function( highlights ) {

        return highlights.map( function( highlight ) {

          // Line range
          if( typeof highlight.end === 'number' ) {
            return highlight.start + RevealHighlight.HIGHLIGHT_LINE_RANGE_DELIMITER + highlight.end;
          }
          // Single line
          else if( typeof highlight.start === 'number' ) {
            return highlight.start;
          }
          // All lines
          else {
            return '';
          }

        } ).join( RevealHighlight.HIGHLIGHT_LINE_DELIMITER );

      } ).join( RevealHighlight.HIGHLIGHT_STEP_DELIMITER );

    }

  }

  Reveal.registerPlugin( 'highlight', RevealHighlight );

  return RevealHighlight;

}));
        
hljs.initHighlightingOnLoad();
</script></body></html>